server.port=7001
spring.application.name=funaistudioworkspace

# Swagger UI ??
# Spring Boot 3 + springdoc 2.x ????? /swagger-ui/index.html
springdoc.swagger-ui.path=/swagger-ui
springdoc.api-docs.path=/v3/api-docs
springdoc.swagger-ui.operationsSorter=method
# ?? Swagger UI
springdoc.swagger-ui.enabled=true
# ??????????
spring.web.resources.add-mappings=true
# ?? springdoc ????
springdoc.api-docs.enabled=true

# -----------------------------
# Workspace（用户在线开发容器）配置（生产环境）
# -----------------------------
funai.workspace.enabled=true
funai.workspace.hostRoot=/data/funai/workspaces
# 使用轻量级 base-node 镜像（不再需要容器内的 MongoDB 和 mongosh）
# MongoDB 已迁移到独立服务器（88），Mongo Explorer 从 87 服务器直接连接
funai.workspace.image=172.21.138.103/funshion/base-node:latest-curl1
funai.workspace.registryUsername=robot$funshion-base
funai.workspace.registryPassword=AgfRy90mC79v9ftD08TdQIa4NCArebH6


funai.workspace.containerPort=5173
## 预览 URL base（不含端口），后端会拼接 :{hostPort}/
funai.workspace.previewBaseUrl=https://studio.fun.tv
## nginx auth_request 内部端口查询接口的共享密钥（nginx 需要在子请求中带 Header：X-WS-Token）
funai.workspace.nginxAuthToken=5082883253738cc32576088cc023b6dfe13aabe155fdd4b16196f387da3bbdb2
funai.workspace.hostPortBase=20000
funai.workspace.hostPortScanSize=2000
funai.workspace.containerWorkdir=/workspace
funai.workspace.containerNamePrefix=ws-u-
# podman/docker 网络名：让 workspace 容器通过容器网络访问 Verdaccio（不依赖访问宿主机）
funai.workspace.networkName=funai-net
# npm registry（推荐同机 Verdaccio；容器内用）：http://verdaccio:4873
#funai.workspace.npmRegistry=http://verdaccio:4873
funai.workspace.npmRegistry=http://172.21.138.103:4873

# npm cache：避免 ~/.npm 造成用户容器层膨胀（删项目不回收磁盘）
# - APP：缓存落到 apps/{appId}/.npm-cache，删除项目目录即可回收（推荐）
funai.workspace.npmCacheMode=APP
# 超过阈值会清理 cache 的大头目录（_cacache/_npx）
funai.workspace.npmCacheMaxMb=1024
funai.workspace.httpProxy=http://host.containers.internal:3128
funai.workspace.httpsProxy=http://host.containers.internal:3128
funai.workspace.noProxy=localhost,127.0.0.1,verdaccio,172.21.138.103,host.containers.internal
# 保守回收策略：减少容器常驻的资源占用
funai.workspace.idleStopRunMinutes=15
funai.workspace.idleStopContainerMinutes=30
# run STARTING 超时（避免前端无限转圈）
funai.workspace.runStartingTimeoutSeconds=300
# 受控任务日志保留（避免 run 目录无限增长）
funai.workspace.runLogKeepPerType=3

# 容器资源限制（保守）：防止少数用户把宿主机打满
# 8c32g 推荐先保守跑稳，再按真实并发/体验逐步放宽
funai.workspace.dockerMemory=2048m
funai.workspace.dockerMemorySwap=2048m
funai.workspace.dockerCpus=1.0
funai.workspace.pidsLimit=512

# -----------------------------
# Workspace Mongo（独立服务器模式）：连接到 88 服务器的 MongoDB
# 说明：
# - 数据库命名：db_{appId}（保持原有命名方式，对前端无影响）
# - 例如：appId=2001 -> db_2001
# -----------------------------
funai.workspace.mongo.enabled=true
funai.workspace.mongo.host=172.21.138.88
funai.workspace.mongo.port=27017
funai.workspace.mongo.username=funai_app
funai.workspace.mongo.password=Ss123456!
funai.workspace.mongo.authSource=admin
funai.workspace.mongo.dbNamePrefix=db_

# ????
logging.level.root=INFO

# -----------------------------
# 日志落盘（workspace-dev / workspace-node）
# -----------------------------
logging.file.name=/data/funai/logs/fun-ai-studio-workspace/app.log

# 按天滚动 + 按大小分片（必须包含 %i；gzip 压缩）
logging.logback.rollingpolicy.file-name-pattern=/data/funai/logs/fun-ai-studio-workspace/app.%d{yyyy-MM-dd}.%i.log.gz
# 单文件最大大小（超过会在同一天内滚动到下一个 %i）
logging.logback.rollingpolicy.max-file-size=100MB

# 保留最近 30 天
logging.logback.rollingpolicy.max-history=7

# 总日志大小上限（超过会清理旧日志）
logging.logback.rollingpolicy.total-size-cap=10GB

# 启动时清理超期日志
logging.logback.rollingpolicy.clean-history-on-start=true

# -----------------------------
# 上传大小限制（upload-zip / upload-file）
# -----------------------------
spring.servlet.multipart.enabled=true
spring.servlet.multipart.max-file-size=200MB
spring.servlet.multipart.max-request-size=200MB
server.tomcat.max-swallow-size=200MB
#
# Tomcat 工作/临时目录（内嵌 Tomcat 默认会在 /tmp 下创建 tomcat.7001.* / tomcat-docbase.7001.*）
# - 生产建议显式指定到持久目录，并配合定期清理，避免 /tmp 堆积
# - 支持环境变量覆盖：FUNAI_TOMCAT_BASEDIR
server.tomcat.basedir=${FUNAI_TOMCAT_BASEDIR:/data/funai/tomcat-workspace}


# -----------------------------
# workspace-node 内部鉴权（只信任 API 服务器（小机））
# - 先跑通：requireSignature=false（仅靠安全组+IP allowlist）
# - API 服务器（小机）代理层加签后：再改为 true
# -----------------------------
# 允许来源 IP（支持逗号分隔列表）
# - API 服务器公网入口：47.93.150.220
# - API 服务器内网 IP（本环境）：172.21.138.91（API -> workspace-dev 走内网时，workspace-dev 看到的 remoteAddr 通常是这个）
workspace-node.internal.allowed-source-ip=47.93.150.220,172.21.138.91
workspace-node.internal.shared-secret=ac462cfa76135504d2b750d541064ed5f03eb9f78f9068645995c4f825455f52
workspace-node.internal.require-signature=false

# -----------------------------
# workspace-node 节点注册/心跳上报（workspace 服务侧）
# -----------------------------
funai.workspace-node-registry-client.enabled=true
# API 服务基址（建议内网）
funai.workspace-node-registry-client.api-base-url=http://172.21.138.91:8080
# 节点名（唯一）
funai.workspace-node-registry-client.node-name=ws-node-01
# 节点 nginx 基址（供 /ws 路由）
funai.workspace-node-registry-client.nginx-base-url=http://127.0.0.1
# 节点 workspace-node API 基址（供 API 转发/签名）
funai.workspace-node-registry-client.node-api-base-url=http://172.21.138.87:7001
# 与 API funai.workspace-node-registry.shared-secret 保持一致
funai.workspace-node-registry-client.token=4f2b1a9c8d3e7a60b1c9d7e5f3a8b6c4d2e0f9a7c5b3d1e8f6a4c2e9b7d5f0a1c3e8b2d6f9a0c4e7b1d5f8a2c6e9b3d7f0a4c8e1b5d9f2a6c0e3b7d1f4a8c2e5b9d0f3a7c1e4b8d2f5a9c3e6b0d4f7a1c5e8b2d6f9a0c4e7b1d5f8a2c6e9b3d7f0a4c8e1b5d9f2a6c0e3b7d1f4a8c2
funai.workspace-node-registry-client.interval-seconds=15

# -----------------------------
# Workspace Git 集成（workspace-bot 密钥、Gitea 远端）
# -----------------------------
funai.workspace.git.enabled=true
funai.workspace.git.ssh-key-path=/opt/fun-ai-studio/keys/gitea/workspace_bot_ed25519
funai.workspace.git.known-hosts-path=/opt/fun-ai-studio/keys/gitea/known_hosts
funai.workspace.git.ssh-user=git
funai.workspace.git.ssh-host=172.21.138.103
funai.workspace.git.ssh-port=2222
funai.workspace.git.repo-owner=funai
funai.workspace.git.repo-name-template=u{userId}-app{appId}
funai.workspace.git.default-branch=main

# -----------------------------
# API 服务地址（用于定时清理任务获取应用列表）
# -----------------------------
funai.api.base-url=http://172.21.138.91:8080


# -----------------------------
# Workspace API Test Configuration
# -----------------------------
funai.workspace.test.default-timeout-seconds=30
funai.workspace.test.max-timeout-seconds=300
funai.workspace.test.max-output-size-bytes=10485760
